FROM oven/bun:1.1.0

WORKDIR /app

# Install runtime dependencies including Node.js
RUN apt-get update && apt-get install -y \
    git \
    curl \
    bash \
    openssh-client \
    jq \
    sudo \
    ca-certificates \
    && curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/*

# Install cloudflared
RUN curl -L "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-arm64" -o /usr/local/bin/cloudflared && \
    chmod +x /usr/local/bin/cloudflared

# Create a non-root user with home directory
RUN addgroup --gid 1001 claude && \
    adduser --system --uid 1001 --ingroup claude --home /home/claude claude

# Install Claude Code CLI globally and make it accessible to all users
RUN bun install -g @anthropic-ai/claude-code@1.0.59 && \
    ls -la /root/.bun/bin/ && \
    ln -sf /root/.bun/bin/claude /usr/local/bin/claude && \
    echo "Testing claude command..." && \
    /usr/local/bin/claude --version

# Ensure the non-root user can also access bun and claude
RUN echo 'export PATH="/home/bun/.bun/bin:$PATH"' >> /home/claude/.bashrc && \
    echo 'export BUN_INSTALL="/home/bun/.bun"' >> /home/claude/.bashrc

# Copy package files
COPY package.json ./
COPY tsconfig.json ./
COPY packages/worker/package.json ./packages/worker/
COPY packages/core-runner/package.json ./packages/core-runner/
COPY packages/dispatcher/package.json ./packages/dispatcher/
COPY packages/orchestrator/package.json ./packages/orchestrator/

# Install all dependencies including devDependencies for building
RUN bun install

# Copy all source code
COPY packages/ ./packages/
COPY scripts/ ./scripts/

# TypeScript is already installed as a devDependency

# Build the worker and core-runner packages
WORKDIR /app/packages/core-runner
RUN bun run build || echo "Warning: core-runner build had errors"

WORKDIR /app/packages/worker  
RUN bun run build || echo "Warning: worker build had errors"

# Verify the build output
RUN ls -la /app/packages/worker/dist/ || echo "No dist directory found"

WORKDIR /app

# Create workspace directory and set permissions
RUN mkdir -p /workspace && \
    chown -R claude:claude /app && \
    chown -R claude:claude /workspace && \
    chmod 755 /workspace

# Copy .claude/projects directory if it exists
COPY --chown=claude:claude .claude/ /home/claude/.claude/

# Ensure .claude directory structure exists for claude user and make scripts executable
RUN mkdir -p /home/claude/.claude/projects && \
    chown -R claude:claude /home/claude/.claude && \
    chmod -R 755 /home/claude/.claude && \
    chmod +x /app/scripts/*.sh

# Switch to non-root user
USER claude

# Set working directory to worker
WORKDIR /app/packages/worker

# Run the compiled JavaScript
ENTRYPOINT ["bun", "run", "dist/index.js"]