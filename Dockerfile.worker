FROM oven/bun:1.2.9

WORKDIR /app

# Install runtime dependencies including Node.js
RUN apt-get update && apt-get install -y \
    git \
    curl \
    bash \
    openssh-client \
    jq \
    sudo \
    ca-certificates \
    procps \
    htop \
    net-tools \
    iputils-ping \
    && curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/* \
    && ln -sf /bin/bash /bin/sh

# Install cloudflared
RUN curl -L "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-arm64" -o /usr/local/bin/cloudflared && \
    chmod +x /usr/local/bin/cloudflared

# Create a non-root user with home directory and sudo access
RUN addgroup --gid 1001 claude && \
    adduser --system --uid 1001 --ingroup claude --home /home/claude claude && \
    echo 'claude ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

# Install Claude Code CLI globally and make it accessible to all users
RUN bun install -g @anthropic-ai/claude-code@1.0.59 && \
    claude_path=$(find /root/.bun -name claude -type f 2>/dev/null | head -1) && \
    if [ -z "$claude_path" ]; then claude_path=$(which claude 2>/dev/null || echo ""); fi && \
    if [ -z "$claude_path" ]; then claude_path=$(find / -name claude -type f -executable 2>/dev/null | grep -v proc | head -1); fi && \
    echo "Found claude at: $claude_path" && \
    if [ -n "$claude_path" ]; then ln -sf "$claude_path" /usr/local/bin/claude; else echo "Warning: Claude binary not found, continuing without symlink"; fi && \
    echo "Testing claude command..." && \
    (/usr/local/bin/claude --version || which claude || echo "Claude installation completed but binary not accessible")

# Ensure the non-root user can also access bun and claude
RUN echo 'export PATH="/home/bun/.bun/bin:$PATH"' >> /home/claude/.bashrc && \
    echo 'export BUN_INSTALL="/home/bun/.bun"' >> /home/claude/.bashrc

# Copy package files
COPY package.json ./
COPY tsconfig.json ./
COPY packages/worker/package.json ./packages/worker/
COPY packages/core-runner/package.json ./packages/core-runner/
COPY packages/dispatcher/package.json ./packages/dispatcher/
COPY packages/orchestrator/package.json ./packages/orchestrator/

# Install all dependencies including devDependencies for building
RUN bun install

# Copy all source code
COPY packages/ ./packages/
COPY scripts/ ./scripts/

# TypeScript is already installed as a devDependency

# Build the worker and core-runner packages
WORKDIR /app/packages/core-runner
RUN bun run build || echo "Warning: core-runner build had errors"

WORKDIR /app/packages/worker  
RUN bun run build || echo "Warning: worker build had errors"

# Verify the build output
RUN ls -la /app/packages/worker/dist/ || echo "No dist directory found"

WORKDIR /app

# Create workspace directory and set permissions
RUN mkdir -p /workspace && \
    chown -R claude:claude /app && \
    chown -R claude:claude /workspace && \
    chmod 755 /workspace

# Copy .claude/projects directory if it exists
COPY --chown=claude:claude .claude/ /home/claude/.claude/

# Ensure .claude directory structure exists for claude user and make scripts executable
RUN mkdir -p /home/claude/.claude/projects && \
    mkdir -p /home/claude/bin && \
    chown -R claude:claude /home/claude/.claude && \
    chown -R claude:claude /home/claude && \
    chmod -R 755 /home/claude/.claude && \
    chmod +x /app/scripts/*.sh && \
    echo 'export PATH="/home/claude/bin:$PATH"' >> /home/claude/.bashrc

# Switch to non-root user
USER claude

# Set working directory to worker
WORKDIR /app/packages/worker

# Start the process monitor in the background and then run the worker
ENTRYPOINT ["/bin/bash", "-c", "/app/packages/worker/scripts/start-process-monitor.sh && exec bun run dist/index.js"]