FROM oven/bun:1.1.0

# Install required packages
RUN apt-get update && apt-get install -y \
    ca-certificates \
    curl \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy all package files
COPY package.json ./
COPY packages/dispatcher/package.json ./packages/dispatcher/
COPY packages/core-runner/package.json ./packages/core-runner/
COPY packages/worker/package.json ./packages/worker/
COPY packages/orchestrator/package.json ./packages/orchestrator/

# Install dependencies
RUN bun install

# Copy source code for dispatcher and core-runner only
COPY packages/dispatcher/ ./packages/dispatcher/
COPY packages/core-runner/ ./packages/core-runner/

# Build
WORKDIR /app/packages/dispatcher
RUN bun run build.ts

# Runtime
ENV NODE_ENV=production
EXPOSE 3000

# Create non-root user
RUN addgroup --gid 1001 --system nodejs && \
    adduser --system --uid 1001 dispatcher

# Switch to non-root user
USER dispatcher

# Use Bun for runtime (better performance)
CMD ["bun", "run", "dist/src/index.js"]